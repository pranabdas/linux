"use strict";(self.webpackChunklinux_tutorial=self.webpackChunklinux_tutorial||[]).push([["8054"],{7571(e,n,a){a.r(n),a.d(n,{metadata:()=>i,default:()=>p,frontMatter:()=>l,contentTitle:()=>t,toc:()=>c,assets:()=>o});var i=JSON.parse('{"id":"singularity-apptainer","title":"Singularity and Apptainer","description":"Apptainer is a fork of Singularity project, both projects are maintained","source":"@site/docs/28-singularity-apptainer.md","sourceDirName":".","slug":"/singularity-apptainer","permalink":"/linux/singularity-apptainer","draft":false,"unlisted":false,"editUrl":"https://github.com/pranabdas/linux/blob/main/docs/28-singularity-apptainer.md","tags":[],"version":"current","sidebarPosition":28,"frontMatter":{"title":"Singularity and Apptainer"},"sidebar":"docs","previous":{"title":"Modules","permalink":"/linux/module"},"next":{"title":"Homebrew","permalink":"/linux/brew"}}'),s=a(4848),r=a(8453);let l={title:"Singularity and Apptainer"},t,o={},c=[{value:"Sandbox mode",id:"sandbox-mode",level:2},{value:"Managing ENV variables",id:"managing-env-variables",level:2},{value:"Managing SIF images with ORAS",id:"managing-sif-images-with-oras",level:2},{value:"Run apptainer in GitHub Codespaces",id:"run-apptainer-in-github-codespaces",level:2},{value:"Resources",id:"resources",level:2}];function d(e){let n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Apptainer is a fork of Singularity project, both projects are maintained\nseparately. We can use ",(0,s.jsx)(n.code,{children:"apptainer"})," and ",(0,s.jsx)(n.code,{children:"singularity"})," commands interchangeably."]}),"\n",(0,s.jsx)(n.p,{children:"Install Apptainer in RHEL based systems:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"dnf install -y epel-release\ndnf install -y apptainer\n"})}),"\n",(0,s.jsx)(n.p,{children:"Install in Debian based systems:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo apt update && sudo apt install -y \\\n    wget \\\n    curl \\\n    fuse3 \\\n    libfuse3-3 \\\n    uidmap \\\n    squashfs-tools\n\n# download latest version of apptainer\nVER=$(curl -s https://api.github.com/repos/apptainer/apptainer/releases/latest | grep tag_name | cut -d '\"' -f 4 | sed 's/v//')\nwget https://github.com/apptainer/apptainer/releases/download/v${VER}/apptainer_${VER}_amd64.deb\n\nsudo apt install -y ./apptainer_${VER}_amd64.deb\nrm apptainer_${VER}_amd64.deb\n"})}),"\n",(0,s.jsx)(n.p,{children:"Pull a docker image (it will convert and write to SIF format):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer pull docker://nvcr.io/hpc/quantum_espresso:qe-7.3.1\n"})}),"\n",(0,s.jsx)(n.p,{children:"Run a program via apptainer:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer exec /qe-7.4.sif /opt/q-e-qe-7.4.1/bin/pw.x -in pw.in | tee pw.out\n"})}),"\n",(0,s.jsx)(n.p,{children:"Bind a directory (some directories are mapped automatically, such as current\nworking directory):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer exec --bind /export:/export /qe-7.4.sif /opt/q-e-qe-7.4.1/bin/pw.x -in pw.in | tee pw.out\n"})}),"\n",(0,s.jsx)(n.p,{children:"Launch apptainer via MPI:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mpirun -np 2 apptainer exec /qe-7.4.sif /opt/q-e-qe-7.4.1/bin/pw.x -in pw.in | tee pw.out\n"})}),"\n",(0,s.jsx)(n.p,{children:"How to pass environment variable to the container:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["We can pass variable with ",(0,s.jsx)(n.code,{children:"--env"})," flag."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'apptainer exec --env MY_VARIABLE="some_value" my-container.sif echo $MY_VARIABLE\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["We can set variables with ",(0,s.jsx)(n.code,{children:"APPTAINERENV_"})," or ",(0,s.jsx)(n.code,{children:"SINGULARITYENV_"})," prefix:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'export APPTAINERENV_MY_VARIABLE="some_value"\napptainer exec my-container.sif env | grep MY_VARIABLE\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Also there are ",(0,s.jsx)(n.code,{children:"APPTAINERENV_PREPEND_PATH"})," and ",(0,s.jsx)(n.code,{children:"APPTAINERENV_APPEND_PATH"})," to\nmodify ",(0,s.jsx)(n.code,{children:"PATH"})," variable."]}),"\n",(0,s.jsx)(n.p,{children:"Example Apptainer definition file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title="espresso.def"',children:'Bootstrap: docker\nFrom: almalinux:9\n\n%labels\n    Maintainer Pranab Das\n    Version QE-7.4.1\n\n%environment\n    export OMP_NUM_THREADS=1\n    export PATH=/usr/lib64/openmpi/bin:$PATH\n    export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH\n\n%post\n    dnf install -y epel-release\n    dnf config-manager --set-enabled crb\n\n    dnf groupinstall -y "Development Tools"\n    dnf install -y wget \\\n        gcc \\\n        gcc-c++ \\\n        gcc-gfortran \\\n        openblas-devel \\\n        lapack-devel \\\n        fftw-devel \\\n        openmpi-devel \\\n        scalapack-openmpi-devel \\\n        libomp-devel\n\n    wget https://github.com/QEF/q-e/archive/refs/tags/qe-7.4.1.tar.gz\n    tar -xf qe-7.4.1.tar.gz\n    rm -f qe-7.4.1.tar.gz\n    cd q-e-qe-7.4.1\n\n    export OMP_NUM_THREADS=1\n    export PATH=/usr/lib64/openmpi/bin:$PATH\n    export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH\n\n    ./configure CC=mpicc \\\n        FC=mpifort \\\n        F77=mpifort \\\n        F90=mpifort \\\n        MPIF90=mpif90 \\\n        --enable-parallel \\\n        --enable-openmp \\\n        --with-scalapack=yes \\\n        --prefix=/opt/qe-7.4.1\n\n    make all -j$(nproc)\n    make install\n\n    rm ..\n    rm -rf q-e-qe-7.4.1\n'})}),"\n",(0,s.jsx)(n.p,{children:"Build container:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer build espresso.sif espresso.def\n"})}),"\n",(0,s.jsx)(n.p,{children:"Recover apptainer definition file from an image. Apptainer file is embedded into\nthe SIF image."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer exec <image_name.sif> cat /.singularity.d/Singularity\n"})}),"\n",(0,s.jsx)(n.h2,{id:"sandbox-mode",children:"Sandbox mode"}),"\n",(0,s.jsxs)(n.p,{children:["We can test commands interactively in sandbox mode. Create a sandbox with\n",(0,s.jsx)(n.code,{children:"--sandbox"})," or ",(0,s.jsx)(n.code,{children:"-s"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer build --sandbox test_sandbox/ docker://ubuntu:latest\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will create a standard directory named test_sandbox that contains full\nLinux OS tree (",(0,s.jsx)(n.code,{children:"/bin"}),", ",(0,s.jsx)(n.code,{children:"/etc"}),", ",(0,s.jsx)(n.code,{children:"/usr"}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["Now to install packages and save them to the sandbox folder, we need to enter\ninto the container in writable mode (use ",(0,s.jsx)(n.code,{children:"--writable"})," or ",(0,s.jsx)(n.code,{children:"-w"})," flag). We will\nalso need ",(0,s.jsx)(n.code,{children:"--fakeroot"})," or ",(0,s.jsx)(n.code,{children:"-f"})," flag to install software as root inside the\ncontainer:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer shell --writable --fakeroot test_sandbox/\n"})}),"\n",(0,s.jsx)(n.p,{children:"Inside the apptainer shell, we can install packages and experiment\ninteractively, for example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"dnf install python3\n"})}),"\n",(0,s.jsx)(n.p,{children:"We can package the sandbox directory into a SIF image:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer build -f espresso.sif test_sandbox/\n"})}),"\n",(0,s.jsx)(n.p,{children:"After the container is build and saved as SIF image, we may delete our sandbox\nfolder. We need to set appropriate permission in order to be able to delete:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"chmod -R u+rwX test_sandbox\nrm -rf test_sandbox\n"})}),"\n",(0,s.jsx)(n.p,{children:"Cleanup apptainer cache:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer cache clean --force\n"})}),"\n",(0,s.jsx)(n.h2,{id:"managing-env-variables",children:"Managing ENV variables"}),"\n",(0,s.jsxs)(n.p,{children:["Apptainer stores ENV variables in severals files under ",(0,s.jsx)(n.code,{children:"/.singularity.d/env"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ ls -l /.singularity.d/env\ntotal 10\n-rwxr-xr-x 1 root root 1337 Aug  1 01:32 01-base.sh\n-rwxr-xr-x 1 root root   85 Aug  1 01:32 10-docker2singularity.sh\n-rwxr-xr-x 1 root root 1707 Dec  6 06:18 90-environment.sh\n-rwxr-xr-x 1 root root    0 Dec  6 06:09 94-appsbase.sh\n-rwxr-xr-x 1 root root 3052 Aug  1 01:32 95-apps.sh\n-rwxr-xr-x 1 root root 1568 Aug  1 01:32 99-base.sh\n-rwxr-xr-x 1 root root  922 Aug  1 01:32 99-runtimevars.sh\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Notice the numerical prefix, they are sourced in alphabetical order by the\nshell. The ENV variables set in the ",(0,s.jsx)(n.code,{children:"%environment"})," definition, goes to\n",(0,s.jsx)(n.code,{children:"90-environment.sh"}),". This file is also symlinked from ",(0,s.jsx)(n.code,{children:"/environment"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ apptainer exec base.sif ls -l /environment\nlrwxrwxrwx 1 root root 36 Dec  6 13:29 /environment -> .singularity.d/env/90-environment.sh\n"})}),"\n",(0,s.jsxs)(n.p,{children:["However, above files are regenerated/",(0,s.jsx)("wbr",{}),"overwritten during the build, they\nare not carried over from the base image. We can save ENV variables to custom\nfiles under the above folder, such files are copied to subsequent child images,\nand automatically sourced by apptainer."]}),"\n",(0,s.jsxs)(n.p,{children:["Such a file could be ",(0,s.jsx)(n.code,{children:"91-environment.sh"})," where we can write variables during the\nbuild (",(0,s.jsx)(n.code,{children:"%post"})," section):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%post\n    echo 'export PATH=/test/path:$PATH' >> $APPTAINER_ENVIRONMENT\n"})}),"\n",(0,s.jsx)(n.p,{children:"or,"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%post\n    cat >> $APPTAINER_ENVIRONMENT <<'EOF'\nexport ONEAPI_ROOT=/opt/intel-2023.1\nexport TBBROOT=$ONEAPI_ROOT/tbb/2021.11\nEOF\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Notice the single quoted ",(0,s.jsx)(n.code,{children:"'EOF'"}),", this prevents variable substitution in the\nheredoc block."]}),"\n",(0,s.jsx)(n.p,{children:"We can inspect ENV variables with:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apptainer inspect --environment <image-name.sif>\napptainer exec <image-name.sif> printenv PATH\n"})}),"\n",(0,s.jsx)(n.p,{children:"During build phase, if required, we can source variables with:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"if [ -f /.singularity.d/env/91-environment.sh ]; then\n    . /.singularity.d/env/91-environment.sh\nfi\n"})}),"\n",(0,s.jsx)(n.p,{children:"or source all ENV files:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'for script in /.singularity.d/env/*.sh; do\n    if [ -f "$script" ]; then\n        . "$script"\n    fi\ndone\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Optionally, we can save variables in custom files, e.g., ",(0,s.jsx)(n.code,{children:"91-oneapi.sh"}),",\n",(0,s.jsx)(n.code,{children:"92-nvhpc.sh"})," etc."]}),"\n",(0,s.jsx)(n.h2,{id:"managing-sif-images-with-oras",children:"Managing SIF images with ORAS"}),"\n",(0,s.jsx)(n.p,{children:"Install ORAS in macos:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"brew install oras\n"})}),"\n",(0,s.jsx)(n.p,{children:"Login to GitHub Container Registry with ORAS (requires GitHub personal access\ntoken with sufficient permission):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"echo $CR_PAT | oras login ghcr.io -u pranabdas --password-stdin\n"})}),"\n",(0,s.jsx)(n.p,{children:"Push a file to GHCR:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"oras push ghcr.io/pranabdas/drive:1.0.0 \\\n    --artifact-type application/text \\\n    ./sample.txt\n"})}),"\n",(0,s.jsx)(n.p,{children:"Fetch details about an object:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"oras manifest fetch ghcr.io/pranabdas/drive:1.0.0\n"})}),"\n",(0,s.jsx)(n.p,{children:"Print SHA-256-SUM of an object:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"oras manifest fetch ghcr.io/pranabdas/drive:1.0.0 | jq '.layers[0].digest' | awk -F: '{print $2}'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Pull an object:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"oras pull ghcr.io/pranabdas/drive:1.0.0\n"})}),"\n",(0,s.jsx)(n.p,{children:"Pull and write object to a specific directory:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"oras pull ghcr.io/pranabdas/drive:1.0.0 --output /opt\n"})}),"\n",(0,s.jsx)(n.p,{children:"An ORAS image can be made associated with a repository by uploading to the\nrepository namespace:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ghcr.io/pranabdas/<repository>/<image>:<tag>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We may need to specify per file media type ",(0,s.jsx)(n.code,{children:"<file-name>:<media-type>"})," to set\nartifact type correctly:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'oras push ghcr.io/pranabdas/ubuntu.sif \\\n  --artifact-type "application/vnd.sylabs.sif.layer.v1.sif" \\\n  "qe.sif:application/vnd.sylabs.sif.layer.v1.sif"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"run-apptainer-in-github-codespaces",children:"Run apptainer in GitHub Codespaces"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Enable via docker-in-docker:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'"features": {\n    "ghcr.io/devcontainers/features/docker-in-docker:2": {\n      "enableNonRootDocker": "true"\n    }\n  },\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"If you do not need full docker-in-docker functionality, execute following\ncommands to enable required permissions:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "name": "My Codespace",\n  "runArgs": [\n      "--cap-add=SYS_ADMIN",\n      "--security-opt", "apparmor=unconfined",\n      "--device=/dev/fuse",\n      "--security-opt", "systempaths=unconfined"\n  ],\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:["Run ",(0,s.jsx)(n.code,{children:"--privileged"})," mode (less secure than option 2):"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "name": "My Codespace",\n  "runArgs": [\n    "--privileged"\n  ],\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.sylabs.io/guides/latest/user-guide/",children:"https://docs.sylabs.io/guides/latest/user-guide/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://apptainer.org/docs/user/main/index.html",children:"https://apptainer.org/docs/user/main/index.html"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://oras.land",children:"https://oras.land"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1145/3332186.3332192",children:"Singularity: Simple, secure containers for compute-driven workloads"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1051/epjconf/202429507005",children:"Apptainer Without Setuid"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1109/CANOPIE-HPC49598.2019.00006",children:"Evaluation and Benchmarking of Singularity MPI containers on EU Research e-Infrastructure"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.3389/fbinf.2021.757291",children:"Singularity Containers Improve Reproducibility and Ease of Use in Computational Image Analysis Workflows"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1109/CANOPIEHPC54579.2021.00007",children:"Feasibility of Running Singularity Containers with Hybrid MPI on NASA High-End Computing Resources"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1371/journal.pone.0177459",children:"Singularity: Scientific containers for mobility of compute"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://doi.org/10.1371/journal.pone.0188511",children:"Enhancing reproducibility in scientific computing: Metrics and registry for Singularity containers"})}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,a){a.d(n,{R:()=>l,x:()=>t});var i=a(6540);let s={},r=i.createContext(s);function l(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);